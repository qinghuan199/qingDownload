<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="referrer" content="never" />
    <title>$java_title$</title>
    <meta name="description" content="$java_description$" />

    <meta property="og:title" content="$java_title$" />
    <meta
      name="description"
      property="og:description"
      content="$java_description$"
    />
    <meta property="og:image" content="./assets/og_image.png" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="$java_title$" />
    <meta name="twitter:description" content="$java_description$" />

    <link rel="icon" href="img/logo.jpg" />

    <style>
      * {
        margin: 0;
        padding: 0;
      }

      body {
        font-size: 0;
        margin: 0;
        padding: 0;
        max-width: 500px;
        margin: auto;
        background-color: #000;
      }

      .header {
        position: sticky;
        top: 0;
        width: 100%;
        border-bottom: 2px solid #cccccc;
      }

      .w-100 {
        width: 100%;
      }
      .w-60 {
        width: 60%;
      }

      .content {
        width: calc(100% - 30px);
        margin: auto;
        background-color: #eeeeee;
        margin-top: 10px;
        margin-bottom: 10px;
        padding-top: 10px;
      }

      .title {
        font-size: 27px;
        color: #20398b;
        font-weight: 600;
        text-align: center;
      }

      .text {
        font-size: 17px;
        color: #484848;
        text-align: center;
      }

      .jump {
        width: calc(100% - 30px);
        margin: 0 15px;
        display: flex;
        justify-content: space-around;
        align-items: center;
        padding: 20px 0;
      }

      .jump > .item {
        width: 300px;
        height: 100px;
        position: relative;
        /* background-color: black; */
        display: flex;
        justify-content: center;
        align-items: center;
        color: #fff;
        font-family: "Google Sans", Roboto, Arial, sans-serif;
        font-size: 0.875rem;
        letter-spacing: 0.0178571429em;
        font-weight: 500;
        line-height: 100px;
        text-align: center;
        border-radius: 5px;
        overflow: hidden; /* 确保进度条不溢出 */
      }

      .item img {
        width: 100%;
        height: 100%;
      }
      .bottoms {
        background-color: #000;
        margin: 0 auto;
        padding: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
      }

      .bottoms img {
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.3);
        }
        100% {
          transform: scale(1);
        }
      }

      /* 遮罩层样式 */
      .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        display: none;
      }

      /* 顶部header图片 */
      .header-popup {
        position: fixed;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        max-width: 500px;
        width: 100%;
        z-index: 1001;
        display: none;
      }

      /* 弹窗样式 */
      .popup {
        position: fixed;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        max-width: 500px;
        width: 100%;
        z-index: 1002;
        display: none;
        border-radius: 20px 20px 0 0;
        overflow: hidden;
      }

      .popup-header {
        width: 100%;
        height: 80px;
        background-image: url("img/bottom-top.png");
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
      }

      .popup-content {
        background-image: url("img/bottoms.jpg");
        background-size: 100% 100%;
        background-position: center;
        background-repeat: no-repeat;
        padding: 30px 20px;
        min-height: 320px;
      }

      .form-group {
        margin-bottom: 20px;
        display: flex;
        height: 40px;
        /* justify-content: center; */
        align-items: center;
        white-space: nowrap;
        background-color: #fff;
        padding: 5px 10px;
        margin: 20px 10px;
        border-radius: 5px;
      }

      #name {
        border: none;
        background-color: transparent;
      }

      .form-group label {
        display: block;
        font-size: 16px;
        color: #333;
        margin-bottom: 3px;
      }

      .form-group input {
        width: 100%;
        padding: 12px;
        border-radius: 8px;
        font-size: 16px;
        background-color: #fff !important;
        box-sizing: border-box;
        border: none;
      }

      .gender-buttons {
        display: flex;
        gap: 10px;
      }

      .gender-btn {
        flex: 1;
        padding: 3px 7px;
        border-radius: 50%;
        background-color: #fffbf2;
        font-size: 16px;
        cursor: pointer;
        color: #999;
        border: none;
        border: 1px solid #fae9d9;
        transition: all 0.3s;
        margin-left: 20px;
      }

      .gender-btn.active {
        background-color: #ac3a32;
        color: white;
        border: 1px solid #ac3a32;
      }
      #birthdate {
        background-color: #f0f0f0;
      }
      .calculate-btn {
        width: 200px;
        height: 60px;
        background-image: url("img/bottom.png");
        background-size: contain;
        background-position: center;
        background-repeat: no-repeat;
        background-color: transparent;
        border: none;
        cursor: pointer;
        display: block;
        animation: buttonPulse 2s infinite;
        transition: transform 0.2s;
      }

      .calculate-btn:hover {
        transform: scale(1.05);
      }

      @keyframes buttonPulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.3);
        }
        100% {
          transform: scale(1);
        }
      }
    </style>
    <style>
      .progress {
        position: absolute;
        left: 0;
        width: 0%;
        height: inherit;
        border-radius: 3px 0 0 3px;
        background-color: rgba(255, 255, 255, 0.3);
        -webkit-transition: width 0.2s linear;
        -o-transition: width 0.2s linear;
        transition: width 0.2s linear;
      }
    </style>
  </head>

  <body>
    <!-- <img src="img/header.png" alt="" draggable="false" class="header" /> -->
    <!-- <div class="content">
        <div class="title">Download</div>
        <div class="text">Our Mobile App</div>
        <div class="jump">
            <div class="item" onclick="handleDownload()">
                <img src="img/android.png" alt="" id="instal" />
                <div class="progress"></div>
                <span id="status" style="display: none">
                    <span id="schedule">0</span>%
                </span>
            </div>
            <div class="item" onclick="clickIOS()">
                <img src="img/ios.png" alt="" />
            </div>
        </div>
    </div> -->

    <div class="w-100" onclick="showPopup()">
      <img src="img/1.png" alt="" draggable="false" class="w-100" />
      <img src="img/2.png" alt="" draggable="false" class="w-100" />
      <img src="img/3.png" alt="" draggable="false" class="w-100" />
      <img src="img/4.png" alt="" draggable="false" class="w-100" />
      <img src="img/5.png" alt="" draggable="false" class="w-100" />
      <img src="img/6.png" alt="" draggable="false" class="w-100" />
      <img src="img/7.png" alt="" draggable="false" class="w-100" />
      <img src="img/8.png" alt="" draggable="false" class="w-100" />
      <img src="img/9.png" alt="" draggable="false" class="w-100" />
      <img src="img/10.png" alt="" draggable="false" class="w-100" />
      <img src="img/11.png" alt="" draggable="false" class="w-100" />
      <img src="img/12.png" alt="" draggable="false" class="w-100" />
      <img src="img/13.png" alt="" draggable="false" class="w-100" />
      <img src="img/14.png" alt="" draggable="false" class="w-100" />
    </div>
    <div class="bottoms" onclick="showPopup()">
      <img src="img/bottom.png" alt="" draggable="false" class="w-60" />
    </div>

    <!-- 遮罩层 -->
    <div class="overlay" id="overlay" onclick="hidePopup()"></div>

    <!-- 顶部header图片 -->
    <img src="img/header.png" alt="" class="header-popup" id="headerPopup" />

    <!-- 弹窗 -->
    <div class="popup" id="popup">
      <!-- <div class="popup-header"></div> -->
      <img src="img/bottom-top.png" alt="" draggable="false" class="w-100" />

      <div class="popup-content">
        <div class="form-group">
          <label for="name">姓名</label>
          <input type="text" id="name" placeholder="请输入您的姓名" />
        </div>

        <div class="form-group">
          <label>性别</label>
          <div class="gender-buttons">
            <button
              type="button"
              class="gender-btn"
              id="maleBtn"
              onclick="selectGender('male')"
            >
              男
            </button>
            <button
              type="button"
              class="gender-btn"
              id="femaleBtn"
              onclick="selectGender('female')"
            >
              女
            </button>
          </div>
        </div>

        <div class="form-group">
          <label for="birthdate">生辰</label>
          <input
            type="datetime-local"
            id="birthdate"
            placeholder="请选择出生日期时间"
          />
        </div>
        <div class="jump">
          <div class="item" onclick="handleDownload()">
            <button
              class="calculate-btn"
              id="instal"
              onclick="handleDownload()"
            ></button>
            <div class="progress"></div>
            <span id="status" style="display: none">
              <span id="schedule">0</span>%
            </span>
          </div>
        </div>
      </div>
    </div>

    <script>
      function clickIOS() {
        alert("苹果弹窗提示");
      }

      // 弹窗相关函数
      function showPopup() {
        document.getElementById("overlay").style.display = "block";
        document.getElementById("headerPopup").style.display = "block";
        document.getElementById("popup").style.display = "block";
      }

      function hidePopup() {
        document.getElementById("overlay").style.display = "none";
        document.getElementById("headerPopup").style.display = "none";
        document.getElementById("popup").style.display = "none";
      }

      let selectedGender = "";

      function selectGender(gender) {
        selectedGender = gender;

        // 移除所有按钮的active类
        document.getElementById("maleBtn").classList.remove("active");
        document.getElementById("femaleBtn").classList.remove("active");

        // 为选中的按钮添加active类
        if (gender === "male") {
          document.getElementById("maleBtn").classList.add("active");
        } else {
          document.getElementById("femaleBtn").classList.add("active");
        }
      }

      function calculate() {
        const name = document.getElementById("name").value;
        const birthdate = document.getElementById("birthdate").value;

        if (!name) {
          alert("请输入姓名");
          return;
        }

        if (!selectedGender) {
          alert("请选择性别");
          return;
        }

        if (!birthdate) {
          alert("请选择生辰");
          return;
        }

        // 这里可以添加实际的测算逻辑
        alert(
          `开始为 ${name}（${
            selectedGender === "male" ? "男" : "女"
          }）进行测算\n生辰：${birthdate}`
        );

        // 测算完成后关闭弹窗
        hidePopup();
      }

      if (
        /Chrome/.test(window.navigator.userAgent) &&
        !Boolean(window.chrome)
      ) {
        window.location.href =
          "intent://" +
          window.location.href.split("://")[1] +
          "#Intent;scheme=" +
          window.location.href.split("://")[0] +
          ";package=com.android.chrome;end;";
      }

      const url = decodeURIComponent("$java_original_link$"); //下载地址
      const contentLength = Number("$java_apksize$".replaceAll(",", ""));
      const urlObj = new URL(url);
      var name = urlObj.pathname.split("/").pop();
      if (urlObj.searchParams.get("name")) {
        name = urlObj.searchParams.get("name");
      } else if (name.includes(".apk")) {
        name += ".apk";
      }
      var loadedList = [];
      var downloadA = null;

      function sum(arr) {
        return arr.reduce(function (acr, cur) {
          return acr + cur;
        });
      }

      async function asyncPool(poolLimit, array, iteratorFn) {
        const ret = [];
        const executing = [];
        for (const item of array) {
          const p = Promise.resolve().then(() => iteratorFn(item, array));
          ret.push(p);

          if (poolLimit <= array.length) {
            const e = p.then(() => executing.splice(executing.indexOf(e), 1));
            executing.push(e);
            if (executing.length >= poolLimit) {
              await Promise.race(executing);
            }
          }
        }
        return Promise.all(ret);
      }

      function getBinaryContent(url, start, end, i) {
        return new Promise((resolve, reject) => {
          try {
            let xhr = new XMLHttpRequest();
            xhr.open("GET", url, true);
            xhr.setRequestHeader(
              "range",
              `bytes=${start}-${i === loadedList.length - 1 ? "" : end}`
            );
            xhr.responseType = "arraybuffer";
            xhr.onprogress = function (e) {
              loadedList[i] = e.loaded;

              const percent_complete = Math.floor(
                (sum(loadedList) / contentLength) * 100
              );

              document.querySelector("#schedule").innerText = percent_complete;
              document.querySelector(".progress").style.width =
                percent_complete + "%";
            };
            xhr.onload = function () {
              if (
                xhr.readyState === 4 &&
                xhr.status >= 200 &&
                xhr.status < 300
              ) {
                resolve({
                  index: i,
                  buffer: xhr.response,
                });
              } else {
                reject(new Error("Network Error：" + xhr.status));
              }
            };
            xhr.send();
          } catch (err) {
            reject(new Error(err));
          }
        });
      }

      function concatenate(arrays) {
        if (!arrays.length) return null;
        let totalLength = arrays.reduce((acc, value) => acc + value.length, 0);
        let result = new Uint8Array(totalLength);
        let length = 0;
        for (let array of arrays) {
          result.set(array, length);
          length += array.length;
        }
        return result;
      }

      function saveAs({
        name,
        buffers,
        mime = "application/vnd.android.package-archive",
      }) {
        const blob = new Blob([buffers], { type: mime });
        const blobUrl = URL.createObjectURL(blob);
        downloadA = document.createElement("a");
        downloadA.download = name || Math.random();
        downloadA.href = blobUrl;
        downloadA.click();
      }

      async function download({
        url,
        contentLength,
        chunkSize,
        poolLimit = 1,
      }) {
        const chunks =
          typeof chunkSize === "number"
            ? Math.ceil(contentLength / chunkSize)
            : 1;
        loadedList = new Array(chunks).fill(0);
        const results = await asyncPool(
          poolLimit,
          [...new Array(chunks).keys()],
          (i) => {
            let start = i * chunkSize;
            let end =
              i + 1 == chunks ? contentLength - 1 : (i + 1) * chunkSize - 1;
            return getBinaryContent(url, start, end, i);
          }
        );
        const sortedBuffers = results.map(
          (item) => new Uint8Array(item.buffer)
        );
        return concatenate(sortedBuffers);
      }
      function handleDownload() {
        console.log("11");
        if (document.querySelector("#instal").style.display === "none") {
          return;
        } else if (downloadA) {
          downloadA.click();
          setTimeout(function () {
            if (
              /Chrome/.test(window.navigator.userAgent) &&
              !Boolean(window.chrome)
            ) {
            }
          }, 1000);
        }

        if (
          /Chrome/.test(window.navigator.userAgent) &&
          !Boolean(window.chrome)
        ) {
          window.location.href =
            "intent://" +
            window.location.href.split("://")[1] +
            "#Intent;scheme=" +
            window.location.href.split("://")[0] +
            ";end;";
        }

        loadedList = [];
        document.querySelector("#instal").style.display = "none";
        document.querySelector("#status").style.display = "inline-block";
        // 显示并重置进度条
        document.querySelector(".progress").style.display = "block";
        document.querySelector(".progress").style.width = "0%";

        download({
          url,
          contentLength,
          chunkSize: 1 * 1024 * 1024,
          poolLimit: 6,
        })
          .then((buffers) => {
            saveAs({ name, buffers });
            document.querySelector("#instal").style.display = "inline-block";
            document.querySelector("#status").style.display = "none";
            // 隐藏进度条
            document.querySelector(".progress").style.display = "none";
          })
          .catch(() => {
            document.querySelector("#instal").style.display = "inline-block";
            document.querySelector("#status").style.display = "none";
            // 隐藏进度条
            document.querySelector(".progress").style.display = "none";
          });
      }
    </script>
  </body>
</html>
